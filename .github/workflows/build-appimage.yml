name: Build Brow6el AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:  # Manual triggering

jobs:
  appimage:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For release uploads

    steps:
      - name: Checkout Brow6el source from Codeberg
        run: |
          git clone --depth 1 https://codeberg.org/janantos/brow6el.git .
          git fetch --tags  # Optional: Fetch tags if needed

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake git pkg-config curl \
            libsixel-dev \
            libx11-dev libxcomposite-dev libxdamage-dev libxext-dev libxfixes-dev \
            libxrandr-dev libgbm-dev libxcb1-dev \
            libpango1.0-dev libatk1.0-dev libcups2-dev libasound2-dev \
            libnss3-dev libnspr4-dev libglib2.0-dev \
            file

      - name: Download CEF binary (x86_64)
        run: ./download_cef.sh

      - name: Build portable version
        run: ./build_portable.sh

      - name: Debug - List build directory contents
        run: ls -la build/ && find build/ -type f | head -20

      - name: Download linuxdeploy (continuous build)
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Prepare AppDir with native build/ structure
        run: |
          # Copy entire portable build contents to AppDir root (matches native build/ layout)
          cp -r build/* AppDir/

          # Verify key files are correctly positioned (as siblings in root)
          if [ ! -f "AppDir/run_brow6el.sh" ] || [ ! -f "AppDir/brow6el" ] || [ ! -d "AppDir/cef" ] || [ ! -d "AppDir/locales" ]; then
            echo "Error: Required files/directories missing after copy"
            ls -la AppDir/
            find AppDir/ -maxdepth 2
            exit 1
          fi

          # Make launcher executable
          chmod +x AppDir/run_brow6el.sh AppDir/brow6el

          # Create usr/share structure for .desktop (required by appimagetool)
          mkdir -p AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/scalable/apps

          # Minimal placeholder icon
          cat > AppDir/usr/share/icons/hicolor/scalable/apps/brow6el.svg << 'EOF'
          <svg width="256" height="256" xmlns="http://www.w3.org/2000/svg">
            <rect width="256" height="256" fill="#ffffff"/>
            <text x="128" y="128" font-size="60" text-anchor="middle" dominant-baseline="middle" fill="#000000">B</text>
          </svg>
          EOF

          # Minimal .desktop referencing root launcher
          cat > AppDir/usr/share/applications/brow6el.desktop << EOF
          [Desktop Entry]
          Name=Brow6el
          Comment=Minimalistic sixel-based web browser (terminal only)
          Exec=run_brow6el.sh %U
          Icon=brow6el
          Type=Application
          Categories=Network;WebBrowser;
          Terminal=true
          Path=.
          EOF

      - name: Bundle dependencies and create AppImage
        run: |
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage \
            --desktop-file AppDir/usr/share/applications/brow6el.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/scalable/apps/brow6el.svg \
            --exclude-library libGL.so.1  # Optional: Exclude if causing issues; CEF bundles graphics

      - name: Verify AppImage structure (debug)
        run: |
          ./Brow6el-*.AppImage --appimage-extract
          ls -la squasfs-root/
          ls -la squasfs-root/* | head -10

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Brow6el-x86_64.AppImage
          path: Brow6el-*.AppImage

      - name: Upload to GitHub Release (on release event)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: Brow6el-*.AppImage
